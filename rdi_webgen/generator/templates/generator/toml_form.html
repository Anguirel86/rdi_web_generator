<!DOCTYPE html>
<html>
    {% load static %}
    <head>
        <title>Rando-Dalton Imperial TOML Generator</title>
        <link rel="icon" type="image/png" href="{% static 'generator/img/DaltonDab.png' %}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/smol-toml@1.4.2/+esm"></script>

        <script type="module">
            import {parse} from 'https://cdn.jsdelivr.net/npm/smol-toml@latest/dist/index.min.js';

            // Populate form fields based on parsed toml data.
            function populateFormFromTomlData(parsed_data) {
                for (const key in parsed_data) {
                    const elem_id = 'id_' + key;
                    const elem = document.getElementById(elem_id);
                    if (elem == null) {continue;}
                    const value = parsed_data[key];

                    if (typeof value == "boolean") {
                        // Handle setting check box flags
                        $('#'+elem_id).prop('checked', value).change();
                    } else if (typeof value == "number") {
                        // Handle setting numeric slider flags
                        $('#'+elem_id).val(value).change();
                        $('#'+elem_id+'_text').val(value).change();
                    } else if (typeof value == "string") {
                        // Handle string types - choice selections/text boxes 
                        $('#'+elem_id).val(value)
                    } else if(value instanceof Array) {
                        // This is one of the list types. Convert the list to
                        // a string before setting the field
                        let text_str = "[";
                        let first_item = true;
                        for (const item of value) {
                            if (first_item) {
                                text_str += "'" + item + "'";
                            } else {
                                text_str += ", " + "'" + item + "'";
                            }
                            first_item = false;
                        }
                        text_str += "]";
                        $('#'+elem_id).val(text_str);
                    }
                }
            }

            async function setPreset(buttonRef, name) {
                // Fetch the specified preset file from the server and
                // set the form fields accordingly.
                try {
                    let status_text = document.getElementById("status_text");
                    status_text.innerHTML = "Fetching preset data...";
                    const response = await fetch("{{request.scheme}}://{{request.get_host}}/fetch_preset/" + name);
                    if (!response.ok) {
                        // Something went wrong with the request
                        let error_text = document.getElementById("error_text");
                        error_text.innerHTML = "Failed to fetch preset file";
                        return;
                    }

                    const data = await response.text();
                    let parsed_data = null;
                    try {
                        parsed_data = parse(data);
                    } catch (error) {
                        let error_text = document.getElementById("error_text");
                        error_text.innerHTML = "Invalid preset file";
                        return;
                    }

                    try {
                        populateFormFromTomlData(parsed_data);
                        status_text.innerHTML = "Loaded preset: " + name;
                    } catch (error) {
                        status_text.innerHTML = "Failed to load preset: " + name;
                    }
                } catch (error) {
                    status_text.innerHTML = "Unable to fetch preset data";
                }
            }
            // Make the function available outside this script module
            window.setPreset = setPreset;


            // Attach an event handler to the file chooser to read the given toml file
            const file_input = document.getElementById('id_existing_toml');
            file_input.addEventListener('change', (event) => {
                // Read the toml and populate the form
                const file = event.target.files[0];

                if (file) {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        let parsed_data = null;
                        try {
                            parsed_data = parse(e.target.result);
                        } catch (error) {
                            let error_text = document.getElementById("error_text")
                            error_text.innerHTML = "Invalid TOML file";
                            return;
                        }

                        let status_text = document.getElementById("status_text");
                        try {
                            populateFormFromTomlData(parsed_data);
                            status_text.innerHTML = "Loaded custom toml file: " + file.name;
                        } catch (error) {
                            status_text.innerHTML = "Failed to load custom toml file: " + file.name;
                        }
                    };

                    reader.onerror = (e) => {
                        let error_text = document.getElementById("error_text")
                        error_text.innerHTML = "Failed to read file";
                        return;
                    };

                    reader.readAsText(file);
                }
            });
        </script>

        <style>
            .movable {
                background-color: lightblue;
                margin: 3px;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                cursor: default;
                white-space: normal;
            }
        </style>

        <script>
            // Functions for multi-select list controls

            function updateSelectedList(dest_id, chosen_list_id) {
                const dest = document.getElementById(dest_id);
                const chosen_list = document.getElementById(chosen_list_id);
                const children = dest.children;
                let chosenItems = "[";

                for (let i = 0; i < children.length; i++) {
                    if (i > 0) {
                        chosenItems += ", ";
                    }
                    chosenItems += children[i].innerText;

                }
                chosenItems += "]";
                chosen_list.value = chosenItems;
            }

            //
            // Add listeners to the components for selecting a list of items.
            // 
            //   src_id: id of the list of unchosen possible items
            //   dest_id: id of the list displaying the selected items
            //   search_id: id of the search/filter input for the src list
            //   chosen_items_id: id of the form element that stores the actual data to be submitted
            //
            function addSelectionListListeners(src_id, dest_id, search_id, chosen_items_id) {
                const src = document.getElementById(src_id);
                const dest = document.getElementById(dest_id);
                const search = document.getElementById(search_id);

                // Add the event handlers to each movable element to move them
                // between the source and destination lists on click.
                $('#'+src_id + ' .movable').map(function() {
                    this.addEventListener('click', function(e) {
                        let elem = $('#'+e.target.id)[0];
                        if (elem.parentElement == dest) {
                            src.appendChild(elem);
                        } else {
                            dest.appendChild(elem);
                        }
                        updateSelectedList(dest_id, chosen_items_id);
                    });
                });

                $('#'+dest_id + ' .movable').map(function() {
                    this.addEventListener('click', function(e) {
                        let elem = $('#'+e.target.id)[0];
                        if (elem.parentElement == dest) {
                            src.appendChild(elem);
                        } else {
                            dest.appendChild(elem);
                        }
                        updateSelectedList(dest_id, chosen_items_id);
                    });
                });

                // Add the filter handler
                search.addEventListener('input', (event) => {
                    const children = src.children;
                    const searchString = search.value;
                    for (let i = 0; i < children.length; i++) {
                        const spanText = children[i].innerText;
                        // Hide children that don't match the search criteria
                        // Display all if the search string is empty
                        if (spanText.includes(searchString) || (searchString.length === 0)) {
                            children[i].style.display = 'inline-block';
                        } else {
                            children[i].style.display = 'none';
                        }
                    }
                });
            }

            function resetMultiSelectList(srcId, destId, itemList) {
                const srcDiv = document.getElementById(srcId);
                const destDiv = document.getElementById(destId);

                // Move all elements to the source list
                const children = destDiv.children;
                for (let i = 0; i < children.length; i++) {
                    srcDiv.appendChild(children[i]);
                }

                if (itemList === "") {
                    // Nothing to do
                    return;
                }

                // Move all items in the itemList over to the dest list
                const itemIdList = itemList.split(",");
                for (const elemId of itemIdList) {
                    const elem = document.getElementById(elemId);
                    destDiv.appendChild(elem);
                }

            }
        </script>

        {% include "generator/toml_gen/reset_function.html" %}

    </head>

    <body>
        <!-- Main form div -->
        <div class="container">
            <div>
                <!-- Error text if form parsing fails on the backend -->
                <h3 id="error_text" style="color: red">{{error_text}}</h3>
            </div>

            <form name="toml_gen_form" id="toml_gen_form" action="{% url 'generator:toml_gen' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- The nav tabs are auto-generated -->
                <div class="border border-primary rounded">
                    <ul class="nav nav-tabs">
                        {% include "generator/toml_gen/settings_nav_tabs.html" %}
                    </ul>
                </div>

                <!-- The individual tab template pages are auto-generated -->
                <div class="tab-content border border-secondary rounded p-2">
                    {% include "generator/toml_gen/settings_tab_pages.html" %}
                </div>

                <!-- form submission and manual elements -->
                <div class="border border-primary rounded p-2 mb-3">
                    <div class="form-group">
                        <input class="btn btn-primary" type="submit" value="Generate settings file"/>
                        <button class="btn btn-primary" type="button" onclick="reset_to_default()">Reset to default</button>
                    </div>
                </div>

            </form> <!-- end toml generate form -->
        </div> <!-- end main container div -->
    </body>
</html>

